<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div>
        <div id="tab1">
            <div>
                <!-- SECCION PARA LOS PRODUCTOS -->
                <div>
                    <div>
                        <div>
                            <span id="tblTitle">Agregar un nuevo producto</span>
                            <form id="frmProduct" data-action="create" data-id="0">
                                <div>
                                    <div>
                                        <div>
                                            <input type="text" name="txtPrdName" id="txtPrdName" required>
                                            <label for="txtPrdName">Nombre</label>
                                        </div>
                                    <div>
                                        <div>
                                            <div>
                                                <label id="lblStatus">
                                                    <input type="checkbox" name="chkStatus" id="chkStatus">
                                                    <span></span>
                                                    Archivo/Camara
                                                </label>
                                            </div>
                                        </div>
                                        <div id="vidContainer">
                                            <div id="btnTakePhoto">
                                                <span>
                                                    <i>Agregar foto</i>
                                                </span>
                                            </div>
                                            <br>
                                            <video id="vidProduct" style="margin-top: 0.5rem;"></video>
                                        </div>
                                        <div id="imgContainer">
                                            <div>
                                                <input type="file" name="imgProduct" id="imgProduct">
                                            </div>
                                            <div>
                                                <input type="text" placeholder="Seleccione una imagen">
                                            </div>
                                        </div>
                                    </div>
                                        <div>
                                            <select name="slcPrdProvider" id="slcPrdProvider" required>
                                                <option value="" disabled selected>Seleccione una marca</option>
                                            </select>
                                            <label for="slcPrdProvider">Proveedores</label>
                                        </div>
                                        <div>
                                            <input type="date" name="txtPrdCreateDate" id="txtPrdCreateDate" required>
                                            <label for="txtPrdCreateDate">Fecha de fabricacion</label>
                                        </div>
                                        <div>
                                            <input type="date" name="txtPrdExpiration" id="txtPrdExpiration" required>
                                            <label for="txtPrdExpiration">Fecha de vencimiento</label>
                                        </div>
                                        <div>
                                            <select name="slcPrdCategory" id="slcPrdCategory" required>
                                                <option value="" disabled selected>Seleccione una categoría</option>
                                            </select>
                                            <label for="slcPrdCategory">Categorias</label>
                                        </div>
                                        <div>
                                            <input type="number" name="txtPrdPrice" id="txtPrdPrice" required>
                                            <label for="txtPrdPrice">Precio</label>
                                        </div>
                                        
                                    </div>
                                    <div>
                                        <div>
                                            <p id="namePrdPreview"></p>
                                            <img src="" alt="" id="imgPrdPreview" class="responsive">
                                            <canvas id="canvas" class="none" hidden></canvas>
                                            <canvas id="canvas2" class="none" hidden></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <button type="submit" name="btnAction">
                                            <i>Enviar</i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Tabla Productos -->
                <div>
                    <div>
                        <div>
                            <span>Productos</span>
                            <table >
                                <thead>
                                    <tr>
                                        <th colspan="9">
                                            <div>
                                                <input type="text" id="txtSearch">
                                                <label for="txtSearch">Buscar</label>
                                            </div>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Proveedor</th>
                                        <th>Fecha de fabricacion</th>
                                        <th>Fecha de vencimiento</th>
                                        <th>Categoria</th>
                                        <th>Precio</th>
                                        <th>Estado</th>
                                        <th>Imagen</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tblProducts">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab2">
            <div>
                <div>
                    <div>
                        <div>
                            <span id="tblTitle">Agregar una nueva categoría</span>
                            <form id="frmCategory" data-action="create" data-id="0">
                                <div>
                                    <div>
                                        <div>
                                            <input type="text" name="txtCatName" id="txtCatName" data-length="25" required>
                                            <label for="txtCatName">Nombre</label>
                                        </div>
                                    </div>
                                    <div>
                                        <div>
                                            <textarea name="txtCatDescription" id="txtCatDescription" data-length="50" required></textarea>
                                            <label for="txtCatDescription">Descripción</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <button type="submit" name="btnCatAction">
                                            <i>send</i>
                                        </button>
                                    </div>
                                    <div>
                                        <button type="reset" name="btnCatReset" id="btnCatReset">
                                            <i>description</i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div>
                    <div>
                        <div>
                            <span>Categorias</span>
                            <table >
                                <thead>
                                    <tr>
                                        <th colspan="3">
                                            <div>
                                                <input type="text" id="txtSearch">
                                                <label for="txtSearch">Buscar</label>
                                            </div>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody id="tblCategories">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div>
                <div>
                    <div>
                        <div>
                            <span id="tblTitle">Agregar un nuevo proveedor</span>
                            <form id="frmProvider" data-action="create" data-id="0">
                                <div>
                                    <div>
                                        <div>
                                            <input type="text" name="txtProvName" id="txtProvName" data-length="50" required>
                                            <label for="txtProvName">Nombre</label>
                                        </div>
                                    </div>
                                    <div>
                                        <div>
                                            <input type="tel" name="txtProvPhone" id="txtProvPhone" data-length="10" required>
                                            <label for="txtProvPhone">Telefono</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <div>
                                            <input type="email" name="txtProvEmail" id="txtProvEmail" data-length="100" required>
                                            <label for="txtProvEmail">Correo</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <button type="submit" name="btnAction">
                                            <i>Enviar</i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div>
                    <div>
                        <div>
                            <span>Proveedores</span>
                            <table >
                                <thead>
                                    <tr>
                                        <th colspan="4">
                                            <div>
                                                <input type="text" id="txtSearch">
                                                <label for="txtSearch">Buscar</label>
                                            </div>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Telefono</th>
                                        <th>Correo</th>
                                    </tr>
                                </thead>
                                <tbody id="tblProviders">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div>
                <div>
                    <div>
                        <div>
                            <span id="tblTitle">Agregar un nuevo usuario</span>
                            <form id="frmProvider" data-action="create" data-id="0">
                                <div>
                                    <div>
                                        <div>
                                            <input type="text" name="txtProvPhone" id="txtProvPhone" data-length="10" required>
                                            <label for="txtProvPhone">Nombre</label>
                                        </div>
                                    </div>
                                    <div id="imgProfileContainer">
                                        <div>
                                            <span>
                                                <i>perm_media</i>
                                            </span>
                                            <input type="file" name="imgProfile" id="imgProfile">
                                        </div>
                                        <div >
                                            <input class="file-path validate" type="text" placeholder="Seleccione una imagen">
                                        </div>
                                    </div>
                                    <div id="vidUserContainer">
                                        <video id="vidUser"></video>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <div>
                                            <input type="text" name="txtProvName" id="txtProvName" data-length="50" required>
                                            <label for="txtProvName">DUI</label>
                                        </div>
                                    </div>
                                    <div>
                                        <div>
                                            <input type="email" name="txtProvEmail" id="txtProvEmail" data-length="100" required>
                                            <label for="txtProvEmail">Correo</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <button type="submit" name="btnAction">
                                            <i>send</i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div>
                    <div>
                        <div>
                            <span>Proveedores</span>
                            <table  id="tblProviders">
                                <thead>
                                    <tr>
                                        <th colspan="4">
                                            <div>
                                                <input type="text" id="txtSearch">
                                                <label for="txtSearch">Buscar</label>
                                            </div>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Telefono</th>
                                        <th>Correo</th>
                                    </tr>
                                </thead>
                                <tbody id="tblProviders">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div>
                <div>
                    <div>
                        <div>
                            <span id="tblTitle">Agregar un nuevo proveedor</span>
                            <form id="frmProvider" data-action="create" data-id="0">
                                <div>
                                    <div>
                                        <div>
                                            <input type="text" name="txtProvName" id="txtProvName" data-length="50" required>
                                            <label for="txtProvName">Nombre</label>
                                        </div>
                                    </div>
                                    <div>
                                        <div>
                                            <input type="tel" name="txtProvPhone" id="txtProvPhone" data-length="10" required>
                                            <label for="txtProvPhone">Telefono</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <div>
                                            <input type="email" name="txtProvEmail" id="txtProvEmail" data-length="100" required>
                                            <label for="txtProvEmail">Correo</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <button type="submit" name="btnAction">
                                            <i>Enviar</i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div>
                    <div>
                        <div>
                            <span>Proveedores</span>
                            <table  id="tblProviders">
                                <thead>
                                    <tr>
                                        <th colspan="4">
                                            <div>
                                                <input type="text" id="txtSearch">
                                                <label for="txtSearch">Buscar</label>
                                            </div>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Telefono</th>
                                        <th>Correo</th>
                                    </tr>
                                </thead>
                                <tbody id="tblProviders">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script>
        function clearForms(form) {
            form.find('input:text, input:password, input:file, input[type=date], input[type=number], select, textarea').val('');
            form.attr('data-action', 'create');
            form.attr('data-id', 0);
        }
        async function showTables() {
            console.log('showTables');
            await adminPetition('http://localhost:3000/show_categories', {}, 'GET', 'tableCategories');
            await adminPetition('http://localhost:3000/show_providers', {}, 'GET', 'tableProviders');
            await adminPetition('http://localhost:3000/show_products', {}, 'GET', 'tableProducts');
        }
        function updateCategory(data) {
            $('#txtCatName').val(data.cat_name);
            $('#txtCatDescription').val(data.cat_description);
            $('#frmCategory').attr('data-action', 'update');
            $('#frmCategory').attr('data-id', data.cat_id);
        }
        function updateProvider(data) {
            $('#txtProvName').val(data.prov_name);
            $('#txtProvPhone').val(data.prov_phone);
            $('#txtProvEmail').val(data.prov_mail);
            $('#frmProvider').attr('data-action', 'update');
            $('#frmProvider').attr('data-id', data.prov_id);    
        }
        function updateProduct(data) {
            $('#txtPrdName').val(data.prt_name);
            $('#slcPrdProvider').val(data.prov_id);
            $('#slcPrdCategory').val(data.cat_id);
            let date = data.prt_createdate.split('/');
            let jsDate = date[2] + '-' + date[1] + '-' + date[0];
            console.log(jsDate);
            $('#txtPrdCreateDate').val(jsDate);
            date = data.prt_expirationdate.split('/');
            jsDate = date[2] + '-' + date[1] + '-' + date[0];
            console.log(jsDate);
            $('#txtPrdExpiration').val(jsDate);
            $('#txtPrdPrice').val(data.prt_cost);
            $('#frmProduct').attr('data-action', 'update');
            $('#frmProduct').attr('data-id', data.prt_id);
            $('select').formSelect();
        }
        function adminPetition(url, data, method, next) {
            let resp;
            console.log('adminPetition>', url, data, method, next);
            if (method == "GET") {
                $.get(url, (res) => {
                    res = res.response;
                    console.log('GET petition response is',res);
                    if (res[1]) {
                        showToast(res[1], 'green rounded');
                        nextStep(next, res[0]);
                    } else {
                        showToast(res, 'red rounded');
                    }
                }, 'json');
            } else if (method == "POST") {
                $.post(url, JSON.stringify(data), (res) => {
                    res = res.response;
                    console.log('POST petition response is', res);
                    showToast(res, 'green rounded');
                    
                    if (Array.isArray(res)) {
                        showToast(res, 'green rounded');
                        nextStep(next, res[0]);
                    } else {
                        showToast(res[1], 'green rounded');
                        nextStep(next, res[0]);
                    }
                }, 'json');
            }
        }
        function nextStep(step, data) {
            console.log('nextStep>', step, data);
            switch (step) {
                case 'tableCategories':
                    $('#tblCategories').html('');
                    data.forEach(element => {
                        $('#slcPrdCategory').append(`
                            <option value="${element.cat_id}">${element.cat_name}</option>
                        `);
                        $('#tblCategories').append(`
                            <tr onclick='updateCategory(${JSON.stringify(element)})'>
                                <td>${element.cat_id}</td>
                                <td>${element.cat_name}</td>
                                <td>${element.cat_description}</td>
                                <td>
                                    <a href="#" onclick='deleteCategory(${JSON.stringify(element)})'>
                                        <i>delete</i>
                                    </a>
                                </td>
                            </tr>
                        `);
                    });
                    $('#slcPrdCategory').formSelect();
                    break;
                case 'tableProviders':
                    $('#tblProviders').html('');
                    data.forEach(element => {
                        $('#slcPrdProvider').append(`
                            <option value="${element.prov_id}">${element.prov_name}</option>
                        `);
                        $('#tblProviders').append(`
                            <tr onclick='updateProvider(${JSON.stringify(element)})'>
                                <td>${element.prov_id}</td>
                                <td>${element.prov_name}</td>
                                <td>${element.prov_phone}</td>
                                <td>${element.prov_mail}</td>
                                <td>
                                    <a href="#" onclick='deleteProvider(${JSON.stringify(element)})'>
                                        <i>delete</i>
                                    </a>
                                </td>
                            </tr>
                        `);
                    });
                    $('#slcPrdProvider').formSelect();
                    break;
                case 'tableProducts':
                    $('#tblProducts').html('');
                    data.forEach(element => {
                        $('#tblProducts').append(`
                            <tr onclick='updateProduct(${JSON.stringify(element)})'>
                                <td>${element.prt_id}</td>
                                <td>${element.prt_name}</td>
                                <td>${element.prov_id }</td>
                                <td>${element.prt_createdate}</td>
                                <td>${element.prt_expirationdate}</td>
                                <td>${element.cat_id}</td>
                                <td>${element.prt_cost}</td>
                                <td>${element.prt_photo}</td>
                                <td>
                                    <a href="#" onclick='deleteProduct(${JSON.stringify(element)})'>
                                        <i>delete</i>
                                    </a>
                                </td>
                            </tr>
                        `);
                    });
                    break;
                default:
                    break;
            }
        }
        function showToast(message, type) {
            console.log('showToast', message, type);
            if (message.status == 'ok') {
                M.toast({
                    html: message.msg,
                    classes: type
                });
            } else if (message.status == 'error') {
                M.toast({
                    html: message.msg,
                    classes: 'red rounded'
                });
            }
        }
        $(document).ready(function(){
            $('select').formSelect();
            $('.tabs').tabs();
            $("select[required]").css({display: "block", height: 0, padding: 0, width: 0, position: 'absolute'});
            $('textarea#txtCatDescription, input#txtCatName, #txtProvName, #txtProvPhone, #txtProvEmail').characterCounter();
            $('#vidContainer').hide();

            showTables();
            let localstream, canvas, video, cxt;

            function takePhoto() {
                canvas = document.getElementById('canvas');
                let canvas2 = document.getElementById('canvas2');
                canvas2.width = video.width;
                canvas2.height = video.height;
                let ctx2 = canvas2.getContext('2d');
                ctx2.drawImage(video, 0, 0, video.width, video.height);
                video.pause();
                setTimeout(e => {
                    video.play();
                }, 1000);

                canvas.width = 28;
                canvas.height = 28;
                ctx = canvas.getContext("2d");
                //Negativo
                ctx.globalCompositeOperation = 'difference';
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                //Escala de grises
                ctx.filter = 'grayscale(100%)';
                cxt.drawImage(video, 0, 0, canvas.width, canvas.height);

                let data = canvas.toDataURL('image/png');
                document.getElementById("imgPrdPreview").src = data;
                //Insertar en la imagen
                let data2 = canvas2.toDataURL('image/png');
                let img = document.getElementById("imgPrdPreview");
                img.src = data2;
            }

            // !CAMBIAR¡ parametro de entrada, canvas, video
            function turnOnCamera() {
                canvas = document.getElementById('canvas');
                cxt = canvas.getContext('2d');
                video = document.getElementById('vidProduct');
                video.width = 400;
                video.height = 400;

                if (!navigator.getUserMedia) {
                    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
                }
                if (!window.URL) {
                    window.URL = window.URL;
                }

                if (navigator.getUserMedia) {
                    navigator.getUserMedia({video: true,audio: false
                    }, function (stream) {
                        try {
                            localstream = stream;
                            video.srcObject = stream;
                            video.play();
                        } catch (err) {
                            console.log(err);
                            video.srcObject = null;
                        }
                    }, function (error) {
                        console.warn('¡Algo ha salido mal!', error); 
                    });
                } else {
                    console.error('¡Ha ocurrido un error!');
                    return
                }
            }

            function turnOffCamera() {
                video.pause();
                video.srcObject = null;
                localstream.getTracks()[0].stop();
            }

            $('#btnTakePhoto').click((e) => {
                e.preventDefault();
                takePhoto();
            });

            // Ejecutar al enviar el formulario de producto
            $('#frmProduct').submit( (e) => {
                e.preventDefault();
                canvas = document.getElementById('canvas');
                cxt = canvas.getContext('2d');

                let action = $('#frmProduct').data('action'),
                    id = $('#frmProduct').data('id'),
                    name = $('#txtPrdName').val(),
                    prov = $('#slcPrdProvider').val(),
                    cat = $('#slcPrdCategory').val(),
                    createdate = $('#txtPrdCreateDate').val(),
                    expirationdate = $('#txtPrdExpiration').val(),
                    cost = $('#txtPrdPrice').val(),
                    photo = $('#imgPrdPreview').attr('src'),
                    data = {action, id, name, prov, cat, createdate, expirationdate, cost, photo:'/img/products/product'};
                console.log(data);

                console.log($('#imgPrdPreview').attr('src'));
                adminPetition('http://localhost:3000/admin_products', data, 'POST', 'tableProducts');
            });

            // Ejecutar al enviar el formulario de categoria
            $('#frmCategory').submit( (e) => {
                e.preventDefault();
                let action = $('#frmCategory').data('action'),
                    id = $('#frmCategory').data('id'),
                    name = $('#txtCatName').val(),
                    description = $('#txtCatDescription').val(),
                    data = {action, id, name, description};
                console.log(data);
                adminPetition('http://localhost:3000/admin_category', data, 'POST', 'tableCategories');
            }).on('reset', (e) => {
                clearForms($('#frmCategory'));
            });

            // Ejecutar al enviar el formulario de proveedor
            $('#frmProvider').submit( (e) => {
                e.preventDefault();
                let action = $('#frmProvider').data('action'),
                    id = $('#frmProvider').data('id'),
                    name = $('#txtProvName').val(),
                    phone = $('#txtProvPhone').val(),
                    mail = $('#txtProvEmail').val(),
                    data = {action, id, name, phone, mail};
                console.log(data);
                adminPetition('http://localhost:3000/admin_provider', data, 'POST', '');
                adminPetition('http://localhost:3000/show_providers', data, 'GET', 'tableProviders');
            }).on('reset', (e) => {
                clearForms($('#frmProvider'));
            });

            $("#chkStatus").change(e => {
                $("#imgProduct").toggleClass("none");
                $("#vidProduct").toggleClass("none");
                if ($("#chkStatus").is(":checked")) {
                    turnOnCamera();
                    $('#vidContainer').show();
                    $('#imgContainer').hide();
                    $("#imgProduct").attr("disabled", true);
                } else {
                    turnOffCamera();
                    $('#imgContainer').show();
                    $('#vidContainer').hide();
                    $("#imgProduct").attr("disabled", false);
                }
            });
        });
    </script>
</body>
</html>